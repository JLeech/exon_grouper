# exon_grouper
файл options содержит параметры для запуска программы:
путь до файла в котором находятся координаты
количество(в процентах) размера пересечения координат экзонов, чтобы отнести их к одной группе.
проценты считаются от длины наименьшего из сравниваемых.
какой формат выходных данных (пока только csv)
для скольки организмов из списка считать группировку.

запуск:
ruby my_painter.rb

результат сохраняется в папку с программой

Есть такой отчёт:
    Что у нас было:
    1) множественное выравнивание
    2) попарные локальные выравнивания для выбранных экзонов
    3) границы (внутри экзонов) локальных выравниваний для каждой пары  

    Какие были идеи:
    1)  Границы как-то сгруппированы внутри экзона.
    2)  Можно перейти от экзона к блокам, соответствующим локальному выравниванию
    3)  Строить по блокам эффективный граф 
    4)? уточнять глобальное выравнивание    

    Что делали:
    1) Рассматривали подмножество связанных (в нашем смысле) экзонов
    2) Для каждых двух экзонов рассматривали их локальные границы
    3) Пытались выделять близкие(по границам) блоки внутри экзонов
    4) Пытались построить граф, где один блок должен был отвечать одной компоненте графа
    5) Пытались построить граф, где в одной компоненте будет лежать граница блока.  

    Что получилось:
    1) Близкие блоки можно выделять, нужно только понять метрику. Бывает, что границы отличаются на 1ед,
     бывает что на 7ед. Как эффективно определять пока не понятно.
    2) Граф по границам блока не даёт особого понимания и содержит циклы(не очень уверен что это плохо).
    3) Есть идея отказаться от глобального выравнивания совсем, и строить глобальное по локальному
    4) Границы, а следовательно и блоки связаны с тем, что какой-то экзон разбился на несколько кусочков. Есть идея смотреть на реальные размеры этих кусочков 
       для определения правильных границ.

Важные замечания:

Входные файлы: 
1) файл с выравниванием в формате fasta 
2) файл с координатами экзонов в этом выравнивании 
3) файл с параметрами запуска (options)

проверки над парами экзонов, подробности в алгоритме:
а) экзоны вложенны
б) условие на max(Rloc_1,Rloc_2)

Результат: 
статистика для вложенных пар экзонов, для которых выполнены проверка а)

1) картинка с экзонами, на которых обозначены номера клик, которым они принадлежат (fasta_cliques)
2) картинка с экзонами, на которых написаны их id (fasta_uids)
3) файл со статистикой (result)
4) файл с парами сравниваемых экзонов (alignements.txt)
5) файл с парами сравниваемых участков для локального выравнивания (local_alignements.txt)
6) файл с внутренними координатами локального выравнивания для каждой пары экзонов (borders.csv)
7) файл с внутренними координатами локального выравнивания для каждой пары экзонов прошедшей проверки а) и б) (graph_borders.csv)

Алгоритм выполенения программы:
На первом этапе происходит парсинг входных данных, в результате которого создаются
структура Organism:
    name - имя
    exons - экзоны (объекты со своей структурой рассмотренной ниже)
    number - порядковый номер организма
    allignement_length - длина выравнивания для организма (у всех одинаковая)

структура Exon:
    start - координата начала экзона в выравнивании
    finish - координата конца экзона в выравнивании
    allignement - последовательность из выравнивания соответствующая этому экзону
    connections - экзоны связанные с рассматриваемым
    real_connections - экзоны формирующие клику
    group - группа к которой относится экзон ( группа в смысле связей)
    uuid - id экзона
    cliques - массив номеров клик в которые входит этот экзон
    organism_index - индекс организма к которому принадлежит экзон
    exon_index - индекс экзона в этом организме
    local_borders - массив всех координат внутренних границ в локальных выравниваниях с этих экзоном  

Два экзона называются вложенными если длина их пересечения в координатах больше или равна длине наименьшего экзона помноженного на порог заданный в файле   
  например ex1 = [10,20], ex2 = [15,27], в скобках - координаты
  длина пересечения(match_length) = 6.
  положим, что порог пересечения(intersect_limit) = 0.5
  если match_length > min(ex1.length,ex2.length)*intersect_limit, то считаем экзоны вложенными.
  в примере 6 > min(11,13)*0.5, т.е 6 > 5.5 => вложены

Затем создаются связи между экзонами по следующему алгоритму:
для каждого организма org из организмов:
  для всех последующих организмов org2:
    для каждого экзона ex1 из org:
      для каждого экзона ex2 из org2:
        если ex1 и ex2 вложенные:
          cчитаем для них всю статистику(см. описание файла статистики)
          если max(Rloc_1, Rloc_2) > 0.3 :
            в массив connected первого экзона добавляем второй экзон
            в массив connected второго экзона добавляем первый экзон

после выполнения этой части алгоритма получается некоторый граф
следующий этап - группировка экзонов:
  Изначально у всех экзонов стоит группа -1
  начинаем с group_number = 1
  для exon из экзонов:
    если группа exon != -1 переходим к следующему
    иначе:
      группу exon устанавливаем в group_number
      далее следует функция set_groups_for_connected:
      для connected_exon из соединённых(находятся в массиве connected ) с exon экзонов:
        если группа connected_exon = -1, то
          устанавливаем группу connected_exon в group_number, и рекурсивно для него запускаем set_groups_for_connected
      инкрементируем group_number

фактически в этом алгоритме в одну группу объединяется одна компонента связности в графе соединённых экзонов.

P.S.
С кликами мы с вами тогда так и не определились, есть несколько методов запрограммированных (отбрасывания двойных рёбер,
выделения подмножества полностью достижимых), но они закомментированы, и не вызываются.

Красным на картинках выделяются экзоны в которых в координатах локальных выравниваний есть пересечения (start_i > end_j)


Добавил в выравнивания ближние экзоны:

можно убрать UU, но кажется что удобно смотреть границы

ПОПРАВИТЬ
длины, сейчас разница координат, должно быть (end-start)+1